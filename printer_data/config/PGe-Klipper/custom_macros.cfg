#############################################################################################################
### CUSTOM MACROS FOR PGe-10
### Här samlar du alla egna makron för RatOS 2.1
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeline"
variable_start_print_park_in: "front"
variable_skew_profile: "Calilantern"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "front"
variable_filament_unload_length: 100
variable_filament_unload_speed: 5

[gcode_macro T0]
variable_cooling_position_to_nozzle_distance: 30
variable_tooolhead_sensor_to_extruder_gear_distance: 380
variable_extruder_gear_to_cooling_position_distance: 30
variable_filament_loading_nozzle_offset: 0
variable_filament_grabbing_length: 5
variable_filament_grabbing_speed: 1
variable_enable_insert_detection: False
variable_enable_runout_detection: True
variable_enable_clog_detection: False
variable_unload_after_runout: True
variable_resume_after_insert: False
variable_extruder_load_speed: 15
variable_filament_load_speed: 5

#############################################################################################################
### START / END / PAUSE / RESUME MACROS
#############################################################################################################
[gcode_macro START_PRINT]
description: Purge line + mesh load + force primeline (override RatOS START_PRINT)
rename_existing: _RATOS_START_PRINT
gcode:
    # 1) hämta ev. värden från slicer
    {% set bed_from_slicer = params.BED|default(None) %}
    {% set hotend_from_slicer = params.EXTRUDER|default(None) %}

    # 2) om slicer inte skickade, ta nuvarande target i Klipper
    {% set bed_temp = (bed_from_slicer if bed_from_slicer is not none else printer.heater_bed.target)|float %}
    {% set hotend_temp = (hotend_from_slicer if hotend_from_slicer is not none else printer.extruder.target)|float %}

    # 3) sista fallback om båda var 0
    {% if bed_temp == 0 %}
        {% set bed_temp = 60.0 %}
    {% endif %}
    {% if hotend_temp == 0 %}
        {% set hotend_temp = 210.0 %}
    {% endif %}

    # se till att RatOS-macrot använder "primeline"
    SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE="'primeline'"

    M140 S{bed_temp}
    M104 S{hotend_temp}

    M190 S{bed_temp}
    M109 S{hotend_temp}

    G90
    G28
    G1 Z10 F600

    {% if printer.ratos.variable_skew_profile is defined %}
        M117 Loading skew profile: {printer.ratos.variable_skew_profile}
        SKEW_PROFILE LOAD={printer.ratos.variable_skew_profile}
    {% endif %}

    BED_MESH_PROFILE LOAD=ratos

    M117 Purge line...
    G90
    G1 X10 Y10 F6000
    G1 Z0.3 F600
    G91
    G1 E5 F300
    G1 X100 E20 F1200
    G90
    G1 Z5 F600

    M117 Printing...
    
[gcode_macro END_PRINT]
description: Safe park, heaters off, fans off
gcode:
    M400                       # Vänta på avslut
    G91                        # Återgå till relativ positionering
    G1 E-3 F2700               # Liten retract
    G1 Z10 F600                # Lyft nozzle
    G90                        # Återgå till absolut positionering 
    G1 X10 Y180 F6000          # Parka bakåt
    M104 S0                    # Stäng av extruder
    M140 S0                    # Stäng av bed
    M107                       # Stäng av fläktar
    M84                        # Disable steppers
    M117 Print finished.

[gcode_macro PAUSE]
description: Pause print, park head safely
rename_existing: BASE_PAUSE
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    M400                       # Vänta på avslut
    G91                        # Återgå till relativ positionering
    G1 E-2 F2100               # Retract 2mm
    G1 Z10 F900                # Lyft 10mm 900speed
    G90                        # Återgå till absolut positionering
    G1 X10 Y180 F6000          # Parkera Y=10mmm in/Y=180mm/6000mm/min
    M117 Print paused
    BASE_PAUSE

[gcode_macro RESUME]
description: Resume print from pause
rename_existing: BASE_RESUME
gcode:
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    M117 Resuming...
    BASE_RESUME

[gcode_macro start_print]
description: Alias so RESTORE_TOOLHEAD_SETTINGS finds it
gcode:
    START_PRINT {rawparams}

[gcode_macro PRINT_START]
description: Alias for older slicers/profiles
gcode:
    START_PRINT {rawparams}