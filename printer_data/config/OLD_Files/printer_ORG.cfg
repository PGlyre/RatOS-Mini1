#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]
[include PGe-Klipper/is.cfg]
[include PGe-Klipper/led_control.cfg]
[include PGe-Klipper/Spoolman.cfg]
#[include PGe-Klipper/PGe_macros.cfg]
#[include XXXXX.cfg]
#[include PGe-Klipper/XXXXX.cfg]
#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[ratos]
allow_unsupported_slicer_versions: True

[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeline"
variable_start_print_park_in: "front"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "front"
variable_filament_unload_length: 100
variable_filament_unload_speed: 5

[gcode_macro T0]
variable_cooling_position_to_nozzle_distance: 30
variable_tooolhead_sensor_to_extruder_gear_distance: 380
variable_extruder_gear_to_cooling_position_distance: 30
variable_filament_loading_nozzle_offset: 0
variable_filament_grabbing_length: 5
variable_filament_grabbing_speed: 1
variable_enable_insert_detection: False
variable_enable_runout_detection: True
variable_enable_clog_detection: False
variable_unload_after_runout: True
variable_resume_after_insert: False
variable_extruder_load_speed: 15
variable_filament_load_speed: 5

#############################################################################################################
### FILAMENT SENSOR
#############################################################################################################
[filament_switch_sensor toolhead_filament_sensor_t0]
pause_on_runout: False
event_delay: 3.0
pause_delay: 0.01
switch_pin: ^PB4
runout_gcode:
	_ON_TOOLHEAD_FILAMENT_SENSOR_RUNOUT TOOLHEAD=0
insert_gcode:
	_ON_TOOLHEAD_FILAMENT_SENSOR_INSERT TOOLHEAD=0

#############################################################################################################
### FANS
### Use 100hz pwm
#############################################################################################################
[heater_fan toolhead_cooling_fan]
heater: extruder
pin: PE9
cycle_time:  0.00004
tachometer_pin: ^PE14
tachometer_poll_interval: 0.0005

[fan]   #[fan part_cooling_fan]
cycle_time: 0.001

#############################################################################################################
### ADXL345 resonance testing configuration
#############################################################################################################
[resonance_tester]
accel_chip_x: adxl345 rpi
accel_chip_y: adxl345 rpi
probe_points:
	90,90,20
    
#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### 
### It is recommended that you follow these steps to properly calibrate your printer:
###
###  - - 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
###
###  - - 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
###
###  - - 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
###
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
###
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
###
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering 
### input shaper configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################
[gcode_arcs]
resolution: 0.1

#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor moves the print head left and right.
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 32 
homing_speed: 50
position_min: 0  #-2
position_max: 180  #180.4
position_endstop: 180  #180.4

#---------------------------------------------------- Y -----------------------------------------------------
# The Y axis motor moves the print bed forward and backward.
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 32 
homing_speed: 50
position_min: -3
position_max: 180
position_endstop: -3

#---------------------------------------------------- Z -----------------------------------------------------
# The Z axis motor moves the print head up and down.
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4 
homing_speed: 10
position_max: 210
position_min: -5

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for your toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: !e_dir_pin       # Add ! in front of pin name to reverse the direction of extruder
rotation_distance: 7.71   # Prusa Mini Extruder default
pressure_advance: 0.38    # SWIFT PET-G.

[heater_bed]

[pause_resume]
recover_velocity: 50.

[stepper_z]
position_max: 185

[probe]
pin: ^PC4
x_offset: -25
y_offset: -5
speed: 5

[probe]
pin: ^probe_pin# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.

[bed_mesh]
speed: 120
horizontal_move_z: 5

# These are in PROBE coordinates, based on your -25 / -5 offsets
mesh_min: 25,5
mesh_max: 155,170
probe_count: 5,5
fade_start: 1.0
fade_end: 10.0
fade_target: 0

#############################################################################################################
# PGe-10 own Override Macros - START
#############################################################################################################
[gcode_macro START_PRINT]
rename_existing: START_PRINT_RATOS
description: Custom start with 100mm primeline (no blob)
gcode:
    {% set hotend_temp = (params.EXTRUDER_TEMP|default(215))|int %}
    {% set bed_temp    = (params.BED_TEMP|default(60))|int %}

    # --- Heat ---
    M117 Heating...
    M140 S{bed_temp}
    M104 S{hotend_temp}
    M190 S{bed_temp}
    M109 S{hotend_temp}

    # --- Home / lift ---
    G90
    G28
    G1 Z10 F600

    # --- OPTIONAL mesh ---
    BED_MESH_PROFILE LOAD=ratos
    # BED_MESH_CALIBRATE

    # --- 100mm primeline instead of blob ---
    M117 Purge line...
    G90
    G1 X10 Y10 F6000      ; change if bed clips are in the way
    G1 Z0.3 F600
    G91
    G1 E5 F300
    G1 X100 E20 F1200
    G90
    G1 Z5 F600

    M117 Printing...

[gcode_macro start_print]
description: Alias so RESTORE_TOOLHEAD_SETTINGS finds it
gcode:
    START_PRINT {rawparams}

[gcode_macro PRINT_START]
description: Alias for older profiles
gcode:
    START_PRINT {rawparams}

[skew_correction]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.025
#*# pid_ki = 2.490
#*# pid_kd = 62.875
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 55.271
#*# pid_ki = 1.208
#*# pid_kd = 632.166
#*#
#*# [probe]
#*# z_offset = 0.780
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	0.258437, 0.241250, 0.272812, -0.010938, -0.011563
#*# 	0.269375, 0.328125, 0.162187, 0.190937, 0.117812
#*# 	0.328437, -0.063750, 0.124687, -0.208125, 0.032812
#*# 	0.315625, 0.356250, 0.081250, 0.114375, -0.005938
#*# 	0.314687, 0.222187, 0.130937, -0.116875, -0.139688
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 155.0
#*# min_y = 5.0
#*# max_y = 170.0
#*#
#*# [skew_correction my_skew_profile]
#*# xy_skew = 0.0011351849500631363
#*# xz_skew = 0.0
#*# yz_skew = 0.0
